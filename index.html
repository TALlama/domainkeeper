<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Domains</title>
    <script src="https://unpkg.com/@colinaut/dice-roller/dist/dice-roller.js"></script>
    <script src="https://unpkg.com/reefjs/dist/reef.min.js"></script>
    <style>
      @layer reset {
        /* http://meyerweb.com/eric/tools/css/reset/ 
          v2.0 | 20110126
          License: none (public domain)
        */

        html, body, div, span, applet, object, iframe,
        h1, h2, h3, h4, h5, h6, p, blockquote, pre,
        a, abbr, acronym, address, big, cite, code,
        del, dfn, em, img, ins, kbd, q, s, samp,
        small, strike, strong, sub, sup, tt, var,
        b, u, i, center,
        dl, dt, dd, ol, ul, li,
        fieldset, form, label, legend,
        table, caption, tbody, tfoot, thead, tr, th, td,
        article, aside, canvas, details, embed, 
        figure, figcaption, footer, header, hgroup, 
        menu, nav, output, ruby, section, summary,
        time, mark, audio, video {
          margin: 0;
          padding: 0;
          border: 0;
          font-size: 100%;
          font: inherit;
          vertical-align: baseline;
        }
        /* HTML5 display-role reset for older browsers */
        article, aside, details, figcaption, figure, 
        footer, header, hgroup, menu, nav, section {
          display: block;
        }
        body {
          line-height: 1;
        }
        ol, ul {
          list-style: none;
        }
        blockquote, q {
          quotes: none;
        }
        blockquote:before, blockquote:after,
        q:before, q:after {
          content: '';
          content: none;
        }
        table {
          border-collapse: collapse;
          border-spacing: 0;
        }
      }

      @layer structure {
        :root {
          --external-margin: 1rem;
          --internal-margin: .5rem;
        }

        * {
          box-sizing: border-box;
        }

        body {
          display: grid;
          grid-template-columns: 15em 1fr;
          grid-gap: var(--external-margin);

          margin: 0;
          padding: 0;
          min-height: 100vh;
        }

        @media (width < 1250px) {
          body {
            grid-template-columns: 10em 1fr;
          }
        }
      }

      @layer baseline {
        strong {
          font-weight: 600;
        }

        ol {
          list-style: circle;
          padding-left: 1em;
        }

        p {
          margin: var(--external-margin) 0;
        }

        button {
          --_button-color: hsl(0, 0%, 80%);
          --_button-border-color: black;
          border: 1px solid var(--button-border-color, var(--_button-border-color));
          font-weight: 600;
          padding: var(--internal-margin);
          background-color: var(--button-color, var(--_button-color));

          &[disabled] {
            --button-color: white;
            --button-border-color: hsl(0, 0%, 80%);
          }

          &:has(> .icon) {
            display: flex;
            align-items: center;

            > .icon {
              width: 25%;
              font-size: 200%;
            }
          }

          > small {
            display: block;
            margin-top: var(--internal-margin);
            font-size: 80%;
            opacity: .8;
          }
        }
      }

      @layer utilities {
        .metadata {
          font-size: 80%;
          color: hsl(0, 0%, 40%);
        }

        .list-unstyled {
          list-style: none;
          margin: 0;
          padding: 0;
        }

        dl.dl-oneline {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(3em, 1fr));

          dt { text-align: end; grid-column: span 2 }
          dt::after { content: ":"; padding-inline-end: var(--internal-margin); }
        }
      }

      @layer components {
        domain-sheet {
          position: sticky;
          top: 0;
          border-right: 3px solid black;
          padding: var(--internal-margin);
          padding-top: 0;
          max-height: 100vh;
          overflow: hidden;

          h3, h4, h5 {
            background: black;
            color: white;
            padding: var(--internal-margin);
            margin: var(--internal-margin) calc(-1 * var(--internal-margin));
            font-size: 80%;
          }

          h6 {
            background: hsl(0, 0%, 90%);
            padding: var(--internal-margin);
            margin: var(--internal-margin) calc(-1 * var(--internal-margin));
            font-size: 80%;
          }

          h3 {
            margin-top: 0;
          }

          .abilities, .stats {
            font-size: 120%;
            margin-bottom: var(--internal-margin);
            padding: var(--internal-margin) 0;
          }

          .abilities {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
          }

          .stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
          }

          .ability-roll {
            margin-right: var(--external-margin);
          }

          input[type="number"] {
            max-width: 5em;
            text-align: end;
          }
        }

        @media (width < 1250px) {
          domain-sheet .abilities {
            label { display: inline-grid; margin-bottom: var(--external-margin) }
          }
        }

        domain-activity-log {
          padding: var(--external-margin);
          padding-left: 0;

          > .status-banner {
            font-size: 200%;
            background-color: red;
            padding: var(--internal-margin);

            &:empty {
              display: none;
            }
          }

          > .activities {
            margin-bottom: var(--external-margin);

            > .activities-list {
              display: grid;
              align-items: flex-end;
              grid-template-columns: repeat(auto-fill, minmax(8em, 1fr));
              gap: var(--internal-margin);
              align-items: stretch;

              + h4 { margin-top: var(--external-margin) }
            }

            h4 {
              font-weight: 600;
            }

            > .leadership-activities {
              --button-color: orange;
            }

            > .civic-activities {
              --button-color: lightblue;
            }

            > .new-turn {
              margin-top: var(--external-margin);
            }

            > .new-turn-pending {
              --button-color: white;
            }
            
            > .new-turn-ready {
              --button-color: green;
            }
          }

          > .entries {
            > .turn-marker {
              display: flex;
              background: linear-gradient(to bottom, transparent, transparent 45%, grey 50%, transparent 55%, transparent);
              justify-content: center;
              margin: calc(2 * var(--external-margin)) 0;

              > .turn-name {
                background: white;
                padding: var(--internal-margin);
              }
            }

            > .entry {
              --bg: grey;
              --description-bg: lightgrey;

              &.leadership-activity { --bg: orange }
              &.civic-activity { --bg: lightblue }

              border: 3px solid var(--bg);
              display: grid;
              grid-template-areas:
                "header     "
                "description"
                "body       ";

              &:has(> .icon) {
                grid-template-columns: 1fr 4rem;
                grid-template-areas:
                  "header      icon"
                  "description icon"
                  "body        body";
              }

              > header {
                grid-area: header;
                display: flex;
                background: var(--bg);
                padding: var(--internal-margin);
              }

              .cancel-activity {
                margin-left: auto;
              }
              &:has(.picked) .cancel-activity { display: none }

              > .icon {
                grid-area: icon;
                font-size: 300%;
                background: var(--bg);
                padding: var(--internal-margin);
              }

              > .description {
                grid-area: description;
                background: var(--description-bg);
                padding: var(--internal-margin);
                font-size: 80%;
              }

              > .body {
                grid-area: body;
                padding: var(--internal-margin);

                h1, h2, h3, h4, h5, h6 {
                  background: var(--description-bg);
                  padding: var(--internal-margin);
                  margin: var(--external-margin) calc(-1 * var(--internal-margin));
                  font-size: 80%;
                }
              }

              + .entry {
                margin-top: var(--external-margin);
              }
            }
          }
        }

        .diff {
          margin-left: var(--internal-margin);
          &::before { content: "("}
          &::after { content: ")"}

          &.diff-negative { color: red }
          &.diff-positive { color: green }
        }

        button .modifier {
          padding-left: var(--internal-margin);
          opacity: .6;
        }

        button.picked, button.pickable:hover {
          --button-color: lch(86% 55 190);
        }

        .outcome {
          &.picked, &:hover {
            &.outcome-critical-success { --button-color: lch(65% 55 185); }
            &.outcome-success { --button-color: lch(65% 55 150); }
            &.outcome-failure { --button-color: lch(65% 55 0); }
            &.outcome-critical-failure { --button-color: lch(65% 55 300); }
          }
        }

        .pickable-group {
          &:has(.picked) {
            .pickable:not(.picked) { --button-color: white; --button-border-color: lightgrey }
          }
        }
      }
    </style>
  </head>
  <body>
    <domain-sheet>
      <script type="x-domain/data">
        {
          "name": "Anvilania",
          "abilityBoosts": [
            ["stability"],
            ["stability"],
            ["stability", "culture"],
            ["stability", "culture", "economy"]
          ]
        }
      </script>
      <h3 data-rx="name"></h3>
      <section class="abilities"></section>
      <section class="stats"></section>

      <section class="leaders">
        <h4>Leaders</h4>
        <ul class="list-unstyled"> </ul>
      </section>

      <section class="settlements">
        <h4>Settlements</h4>
        <ul class="list-unstyled"> </ul>
      </section>

      <section class="rolls">
        <h4>Dice tray</h4>
        <article class="dice-tray"></article>
      </section>
    </domain-sheet>

    <domain-activity-log>
      <aside class="status-banner"></aside>
      <aside class="activities"></aside>
    </domain-activity-log>

    <script> // Extensions
      Array.prototype.random = Array.prototype.random || function () {
        return this[Math.floor((Math.random()*this.length))];
      };
    </script>
    <script> // Maker
      class Maker {
        static tag(tagName, ...parts) {
          let el = tagName.tagName ? tagName : document.createElement(tagName);
          
          parts.forEach(part => {
            if (part === null || part === undefined) {
              // ignore
            } else if ("string boolean number".split(' ').includes(typeof part) || part.tagName) {
              el.append(part);
            } else if (Array.isArray(part)) {
              Maker.tag(el, ...part);
            } else if ("function" === typeof part) {
              Maker.tag(el, part.call(el, el));
            } else {
              Maker.setAttributes(el, part);
            }
          })
          
          return el;
        }

        static setAttributes(el, attributes) {
          for (let [name, value] of Object.entries(attributes || {})) {
            if (value !== null && value !== undefined) {
              if (name == "prependTo") { value.prepend(el); continue; }
              if (name == "appendTo") { value.append(el); continue; }
              if (name == "rx") { reef.component(el, value); continue; }
              if (name == "click") { el.addEventListener(name, value); continue; }
              if (name == "class") { value = [el.className, value].join(' ').trim() }
              
              el.setAttribute(name, value);
            }
          }
          return el;
        }

        static p(...parts) { return Maker.tag("p", ...parts) }
        static ol(...items) { return Maker.tag("ol", items.map(i => Maker.tag("li", i))) }

        static dl(dictionary, ...parts) {
          return Maker.tag("dl",
            Object.entries(dictionary).flatMap((key_value, index) => {
              let [key, value] = key_value;
              return [Maker.tag("dt", key), Maker.tag("dd", value)]
            }),
            ...parts,
          );
        }
      }
    </script>
    <script> // Domain
      class RxElement extends HTMLElement {
        $ = this.querySelector;
        $$ = this.querySelectorAll;

        fillRx(signal) {
          this.$$("[data-rx]").forEach((elem) => {
            reef.component(elem, () => signal[elem.dataset.rx]);
          });
        }
      }
    </script>
    <script> // Leaders
      class DomainLeader extends RxElement {
        constructor(properties) {
          super();
          Object.assign(this, properties);
          this.activitiesPerTurn ??= this.type == "PC" ? 2 : 1;
        }
      }
      customElements.define("domain-leader", DomainLeader);
    </script>
    <script> // Domain
      class DomainSheet extends RxElement {
        connectedCallback() {
          this.data = reef.signal(this.loadData());
          this.makeReactive();
        }

        loadData() {
          let saved = JSON.parse(this.$("script[type='x-domain/data']")?.innerHTML || "{}");
          let abilitiesStartAt = 2;

          saved.level ??= 1;
          saved.culture ??= abilitiesStartAt;
          saved.economy ??= abilitiesStartAt;
          saved.loyalty ??= abilitiesStartAt;
          saved.stability ??= abilitiesStartAt;
          saved.unrest ??= 0;
          saved.fame ??= 1;
          saved.size ??= 1;
          saved.xp ??= 0;
          saved.level ??= 1;
          saved.leaders ??= [
            new DomainLeader({type: "PC", name: "Seth"}),
            new DomainLeader({type: "PC", name: "Ben"}),
            new DomainLeader({type: "PC", name: "David"}),
            new DomainLeader({type: "PC", name: "Morgan"}),
            new DomainLeader({type: "PC", name: "Joe"}),
            new DomainLeader({type: "NPC", name: "Bertie", activitiesPerTurn: 1}),
          ];
          saved.settlements ??= [
            new DomainLeader({type: "Village", name: "Capital", activitiesPerTurn: 1}),
          ]

          return saved;
        }

        get abilitiesList() { return this.$(".abilities") }
        get statsList() { return this.$(".stats") }

        makeReactive() {
          this.fillRx(this.data);
          this.fillLeaders();
          this.fillSettlements();

          "Stability Loyalty Economy Culture".split(" ").forEach((ability) => {
            Maker.tag("div", {prependTo: this.abilitiesList},
              Maker.tag("a", {href: "#", class: "ability-roll", "data-ability": ability}, "üé≤"),
              Maker.tag("label", {rx: () => {
                let value = this.data[ability.toLocaleLowerCase()];
                return `<span class="ability-name">${ability}</span> <input type="number" @value="${value}" data-in="${ability}" min="0" /> `;
              }}));
          });

          "Unrest Fame Size XP".split(" ").forEach((stat) => {
            Maker.tag("label", {appendTo: this.statsList, rx: () => `<label>${stat} <input type="number" @value="${this.data[stat.toLocaleLowerCase()]}" data-in="${stat}" min="0" /></label>`})
          })
          Maker.tag("label", {appendTo: this.statsList, rx: () => `<label>Level <input type="number" @value="${this.data.level}" data-in="Level" min=1 max=20 /></label>`});
          Maker.tag("label", {appendTo: this.statsList, rx: () => `<label>Control DC <input type="number" @value="${this.controlDC}" readonly /></label>`});;

          this.addEventListener("change", (event) => {
            let input = event.target.closest("[data-in]");
            if (input) { this.data[input.dataset.in.toLocaleLowerCase()] = Number(input.value) }
          })
        }

        fillLeaders() {
          this.leadersComponent ||= reef.component(this.$(".leaders ul"), () =>
            this.data.leaders.map(leader => `<li key="${leader}">${leader.type}: ${leader.name} <span class='metadata'>${leader.activitiesPerTurn} ${leader.activitiesPerTurn == 1 ? "activity" : "activities"}</li>`).join("")
          )
        }

        fillSettlements() {
          reef.component(this.$(".settlements ul"), () =>
            this.data.settlements.map(settlement => `<li key="${settlement}">${settlement.type}: ${settlement.name} <span class='metadata'>${settlement.activitiesPerTurn} ${settlement.activitiesPerTurn == 1 ? "activity" : "activities"}</li>`).join("")
          )
        }

        get leadershipActivitiesPerTurn() { return this.data.leaders.reduce((total, leader) => total + leader.activitiesPerTurn, 0) }
        get civicActivitiesPerTurn() { return this.data.settlements.reduce((total, settlement) => total + settlement.activitiesPerTurn, 0) }

        get controlDC() {
          let baseControlDCByLevel = {
            1: 14, // Charter, government, heartland, initial proficiencies, favored land, settlement construction (village)
            2: 15, // Kingdom feat
            3: 16, // Settlement construction (town), skill increase
            4: 18, // Expansion expert, fine living, Kingdom feat
            5: 20, // Ability boosts, ruin resistance, skill increase
            6: 22, // Kingdom feat
            7: 23, // Skill increase
            8: 24, // Experienced leadership +2, Kingdom feat, ruin resistance
            9: 26, // Expansion expert (Claim Hex 3 times/turn), settlement construction (city), skill increase
            10: 27, // Ability boosts, Kingdom feat, life of luxury
            11: 28, // Ruin resistance, skill increase
            12: 30, // Civic planning, Kingdom feat
            13: 31, // Skill increase
            14: 32, // Kingdom feat, ruin resistance
            15: 34, // Ability boosts, settlement construction (metropolis), skill increase
            16: 35, // Experienced leadership +3, Kingdom feat
            17: 36, // Ruin resistance, skill increase
            18: 38, // Kingdom feat
            19: 39, // Skill increase
            20: 40, // Ability boosts, envy of the world, Kingdom feat, ruin resistance
          };
    
          return this.data.size + baseControlDCByLevel[this.data.level];
        }

        mod(ability) {
          let score = this.data[ability.toLocaleLowerCase()];
          return `${score >= 0 ? "+" : ""}${score}`;
        }

        get abilityScores() {
          return {
            Culture: this.data.culture,
            Economy: this.data.economy,
            Loyalty: this.data.loyalty,
            Stability: this.data.stability,
          };
        }

        abilityScoresWithDiffs(baseline, newValues = this.abilityScores) {
          let retval = {};
          Object.keys(newValues).forEach((ability) => {
            let value = newValues[ability];
            let diff = value - baseline[ability];
            let signClass = diff > 0 ? "diff-positive" : (diff < 0 ? "diff-negative" : "diff-flat");
            retval[ability] = [value, Maker.tag("span", {class: `metadata diff ${signClass}`}, `${diff >= 0 ? "+" : ""}${diff}`)];
          });
          return retval;
        }

        get statScores() {
          return {
            Unrest: this.data.unrest,
            Fame: this.data.fame,
            Size: this.data.size,
            XP: this.data.xp,
            Level: this.data.level,
          };
        }

        modify(diff, ...names) { names.forEach(name => { this.data[name.toLocaleLowerCase()] += diff }) }
        boost(...names) { this.modify(1, ...names) }
        reduce(...names) { this.modify(-1, ...names) }

        get unrestModifier() {
          let unrest = this.data.unrest;
          return unrest >= 15 ? -4 : (unrest >= 10 ? -3 : (unrest >= 5 ? -2 : (unrest >= 1 ? -1 : 0)));
        }

        get diceTray() { return this.$(".dice-tray") }

        roll({die, modifier, level, dc}) {
          let modifierValue = (modifier ? this.data[modifier.toLocaleLowerCase()] : 0);
          let levelValue = (level === false ? 0 : this.data.level);

          let components = [[modifier, modifierValue], ["Level", levelValue], ["Unrest", this.unrestModifier]];
          let modifierTotal = 0;

          let header = Maker.tag("h6");
          components.forEach((component) => {
            let [name, value] = component;
            if (value !== 0) {
              header.append(` ${value > 0 ? "+" : "-"} ${name} (${Math.abs(value)})`);
              modifierTotal += value;
            }
          })

          let roller = Maker.tag(
            "dice-roller",
            {dice: die || 20, modifier: modifierTotal},
          );
          if (dc !== false) {
            dc = dc || this.controlDC;
            header.append(` vs ${dc}`);
            dc -= modifierTotal; // see https://github.com/colinaut/dice-roller/issues/1
            roller.setAttribute("difficulty", Math.max(1, dc));
          }
          this.diceTray.prepend(roller);
          this.diceTray.prepend(header);
          roller.shadowRoot.querySelector("div").click(); // Ew
        }
      }
      customElements.define("domain-sheet", DomainSheet);
    </script>
    <script> // Ability rolls
      document.addEventListener("click", (event) => {
        let trigger = event.target.closest(".ability-roll");
        if (trigger) { document.querySelector("domain-sheet").roll({modifier: trigger.dataset.ability}) }
      })
    </script>
    <script> // Pickable buttons
      document.addEventListener("click", (event) => {
        let trigger = event.target.closest(".pickable");
        if (trigger) { trigger.classList.toggle("picked") }
      })
    </script>
    <script> // Activities
      class Activity extends RxElement {
        constructor(properties) {
          super();

          Object.assign(this, properties);
          this.abilities ||= this.abilities || ["Culture", "Economy", "Loyalty", "Stability"];

          Maker.tag(this, {class: "entry activity"},
            {class: (LeadershipActivity === this.constructor ? "leadership-activity" : "")},
            {class: (CivicActivity === this.constructor ? "civic-activity" : "")},
            Maker.tag("header", this.name, Maker.tag("a", "Cancel", {href: "#", class: "cancel-activity", click: () => this.cancel()})),
            Maker.tag("span", {class: "icon"}, this.icon),
            Maker.tag("blockquote", {class: "description"}, this.description),
            Maker.tag("section", {class: "body"}, (el) => this.body(el, this)),
          );
        }

        body(into) {
          Maker.tag(into, this.callOrReturn(this.preprompt), this.promptSection, this.preoutcome, this.outcomeSection, Maker.tag("section", {class: "log"}));
        }

        callOrReturn(value) { return value?.call ? value.call(this, this) : value }

        get activityLog() { return this.closest("domain-activity-log") }
        get domainSheet() { return document.querySelector("domain-sheet") }
        get promptSection() { return Maker.tag("section", {class: "prompt pickable-group"}, this.prompt) }
        set prompt(value) { this._prompt = value }
        get prompt() { return this.callOrReturn(this._prompt) ?? [Maker.tag("h4", this.promptText), this.abilities.flatMap(a => this.roll(a))] }
        set promptText(value) { this._promptText = value }
        get promptText() { return this.callOrReturn(this._promptText) ?? (this.abilities.length === 1 ? "Roll:" : "Roll one:") }
        get pickedPrompt() { return this.$(".prompt .picked") }
        get pickedPromptAbility() { return this.pickedPrompt.dataset.ability }

        get belowAbility() { return {Culture: "Economy", Economy: "Loyalty", Loyalty: "Stability", Stability: "Culture"}[this.pickedPromptAbility] }
        get aboveAbility() { return {Stability: "Loyalty", Loyalty: "Economy", Economy: "Culture", Culture: "Stability"}[this.pickedPromptAbility] }
        get randomAbility() { return "Culture Economy Loyalty Stability".split(" ").random() }

        get outcomeSection() { return Maker.tag("section", {class: "outcome pickable-group"}, this.outcome) }
        set outcome(value) { this._outcome = value }
        get outcome() {
          return this.callOrReturn(this._outcome) ?? [
            Maker.tag("h4", "Result:"),
            Maker.tag("button", `Critical Success`, Maker.tag("small", this.criticalSuccessDescription), {class: "pickable outcome outcome-critical-success", click: () => { this.criticalSuccess() }}),
            Maker.tag("button", `Success`, Maker.tag("small", this.successDescription), {class: "pickable outcome outcome-success", click: () => { this.success() }}),
            Maker.tag("button", `Failure`, Maker.tag("small", this.failureDescription), {class: "pickable outcome outcome-failure", click: () => { this.failure() }}),
            Maker.tag("button", `Critical Failure`, Maker.tag("small", this.criticalFailureDescription), {class: "pickable outcome outcome-critical-failure", click: () => { this.criticalFailure() }}),
          ];
        }
        get pickedOutcome() { return this.$(".outcome .picked") }

        criticalSuccess() { this.success() }
        success() { this.log('Good job!') }
        failure() { this.log('Oh no!') }
        criticalFailure() { this.failure() }

        cancel() {
          let activities = this.activityLog.currentTurn.activities;
          let ixThis = activities.findIndex(i => i == this);
          activities.splice(ixThis, 1);
          this.activityLog.countRemainingActivities();

          this.remove();
        }

        log(...parts) { return Maker.tag("p", ...parts, {appendTo: this.logElement}); }
        get logElement() { return this.$('.log') }

        roll(ability) {
          return Maker.tag("button",
            {"class": "ability-roll pickable", "data-ability": ability},
            ability,
            Maker.tag("span", ` ${this.domainSheet.mod(ability)}`, {class: "modifier"}));
        }

        boost(...abilities) {
          abilities.forEach(ability => {
            this.log(`üìà Boosted ${ability}`);
            this.domainSheet.boost(ability)
          });
        }

        reduce(...abilities) {
          abilities.forEach(ability => {
            this.log(`üìâ Reduced ${ability}`);
            this.domainSheet.reduce(ability)
          });
        }

        // Formatting options
        static tagged(tag, ...parts) { return Maker.tag("li", Maker.tag("strong", `${tag} `), ...parts) }
        static prereq(...parts) { return Activity.tagged("Requirements", ...parts) }
        static special(...parts) { return Activity.tagged("Special", ...parts) }

        pickOne(items, options) {
          let {prompt, appendTo, beforeItems, afterItems} = options;
          beforeItems ??= [];
          afterItems ??= [];

          return Maker.tag("section", {class: "pick-one", appendTo: appendTo || this.logElement},
            options.prompt || `Pick one:`,
            Maker.ol(
              ...beforeItems,
              ...items.map(item => this.pickOneItem(item, options)),
              ...afterItems,
            ),
          );
        }

        pickOneItem(item, {format, andThen} = {}) {
          let text = (format || ((i) => i.toString())).call(item, item);
          return Maker.tag("a", text, {href: "#", click: (event) => andThen(item, {event})});
        }

        modAndThen({ability, by, andThen} = {}) {
          by ??= -1;
          andThen ??= () => {};

          return () => {
            let direction = by > 0 ? "boost" : "reduce";
            let steps = Math.abs(by);
            this[direction](...new Array(steps).fill(ability));
            return andThen();
          }
        }

        modOneAnd(format, options = {}) {
          let by = options.by ?? 1;
          let text = (ability) => format.replace("{ability}", ability).replace("{by}", Math.abs(by));

          return this.pickOne([], {...options, beforeItems: "Culture Economy Loyalty Stability".split(" ").map(ability =>
            this.pickOneItem(text(ability), {...options, andThen: this.modAndThen({...options, ability: ability})}),
          )});
        }

        button({disabled} = {}) {
          return `<button title="${this.description}" data-action="doActivity" data-activity="${this.name}" ${disabled ? "disabled" : ""}>
            <span class="icon">${this.icon}</span>
            ${this.name}
          </button>`
        }

        static get all() { return [...LeadershipActivity.all, ...CivicActivity.all] }
      }

      class SystemActivity extends Activity {
      }
      customElements.define("system-activity", SystemActivity);

      class LeadershipActivity extends Activity {
        static get all() {
          let {p, ol} = Maker;
          let {tagged, prereq, special} = Activity;
          let hexMods = `Additional Modifier (not factored in): Mountains: -4; Swamps: -3; Forests: -2; Hills: -1; Plains: -0. `;

          return [
            new LeadershipActivity({
              icon: "üë∑üèª‚Äç‚ôÇÔ∏è",
              name: "Clear Hex",
              description: "You lead the effort to clear out the dangers in an already-reconnoitered hex.",
              abilities: ["Economy", "Stability"],
              preprompt: [
                p(`Engineers and mercenaries attempt to prepare a hex to serve as the site for a settlement, or they work to remove an existing improvement, a dangerous hazard, or an encounter.`),
                ol(
                  `If you‚Äôre trying to prepare a hex for a settlement or demolish an improvement you previously built (or that was already present in the hex), use Economy.`,
                  `If you‚Äôre trying to remove a hazard or encounter, use Stability. The DC of this check is set by the highest level creature or hazard in the hex (as set by Table 10‚Äì5: DCs by Level, on page 503 of the Pathfinder Core Rulebook).`,
                  `If the hex is outside your domain, increase the DC by 2.`,
                  hexMods,
                )],
              criticalSuccessDescription: `Clear hex and boost economy`,
              successDescription: `Clear hex`,
              failureDescription: `Fail`,
              criticalFailureDescription: `Unrest`,
              criticalSuccess() { this.success(); this.log("üêª You brought back spoils!"); this.boost("Economy") },
              success() { this.log("üéâ You successfully clear the hex.") },
              failure() { this.log("‚ùå You fail to clear the hex.") },
              criticalFailure() { this.log("üíÄ You catastrophically fail to clear the hex and several workers lose their lives."); this.boost("Unrest") },
            }),
            new LeadershipActivity({
              icon: "üéè",
              name: "Claim Hex",
              description: "You bring the cleared hex into the domain.",
              preprompt: [
                prereq(`You have Reconnoitered the hex to be claimed during hexploration. This hex must be adjacent to at least one hex that‚Äôs already part of your domain. If the hex to be claimed contains dangerous hazards or monsters, they must first be cleared out‚Äîeither via standard adventuring or the Clear Hex activity.`),
                p(`Your surveyors fully explore the hex and attempt to add it into your domain.`),
              ],
              abilities: ["Economy", "Stability"],
              criticalSuccessDescription: `Claim hex; Boost a random stat`,
              successDescription: `Claim hex`,
              failureDescription: `Fail`,
              criticalFailureDescription: `-1 Stability for rest of turn`,
              criticalSuccess() {
                this.success();
                let [ability, message] = [
                  ["Culture", "üéµ The speed of your occupation becomes a popular folk song around the domain."],
                  ["Economy", "ü¶å A grand hunt in the new territory brings great wealth to the domain."],
                  ["Loyalty", "üéñÔ∏è The pioneers tell of your exploits and spread word of your deeds across the domain ."],
                  ["Stability", "üê¥ The integration goes flawlessly thanks to your careful planning."],
                ].random();
                this.log(message);
                this.boost(ability);
              },
              success() {
                this.log(`üéâ You claim the hex and immediately add it to your territory, increasing Size by 1 (this affects all statistics determined by Size; see page 38). Your occupation of the hex goes so smoothly that you can immediately attempt another Region activity.`);
                this.boost("Size");
              },
              failure() { this.log(`‚ùå You fail to claim the hex`) },
              criticalFailure() {
                this.log(`üíÄ You fail to claim the hex, and a number of early settlers and explorers are lost, causing you to take a ‚Äì1 circumstance penalty to Stability-based checks until the end of your next turn.`);
              },
            }),
            new LeadershipActivity({
              icon: "üèÉ‚Äç‚ôÇÔ∏è",
              name: "Abandon Hex",
              description: "You renounce the domain's claim to a hex.",
              abilities: ["Stability"],
              preprompt: [
                prereq(`The hex to be abandoned must be controlled.`),
                p(`After careful consideration, you decide that you would rather not hold onto a particular hex as part of your claimed territory. You renounce your claim to it and pull back any settlers or explorers. Attempt a basic Exploration or Wilderness check. You can abandon more than one hex at a time, but each additional hex you abandon increases the DC of this check by 1.`),
                special(`The Unrest gained from abandoning a hex doubles if it includes a settlement. A settlement in an abandoned hex becomes a Freehold (page 41).`),
              ],
              criticalSuccessDescription: `Abandon Hex; Economy boost`,
              successDescription: `Abandon hex; Unrest`,
              failureDescription: `Abandon hex; Unrest + 2; Possible Squatters event`,
              criticalFailureDescription: `Abandon hex; Unrest +3; Definite Bandit Activity Event`,
              criticalSuccess() {
                this.success();
                this.log(`‚ö±Ô∏è Settlers and explorers return and resettle elsewhere in your domain, bringing with them bits of salvage from the abandoned hexes.`)
                this.boost("Economy"); // this is the old `Gain 1 RP per abandoned hex`
              },
              success() {
                this.log(`üéâ You abandon the hex or hexes, decreasing Size by 1 per hex abandoned (this affects all statistics determined by Size; see page 38).`);
                this.reduce("Size");
                this.boost("Unrest");
              },
              failure() {
                this.success();
                this.log(`üò† Some citizens become disgruntled refugees who refuse to leave the hex. Increase Unrest by add additional point and then attempt a DC 6 flat check. If you fail, the refugees become bandits, and during your next Event phase, you experience a Squatters event automatically in addition to any other event that might occur.`);
                this.boost("Unrest");
              },
              criticalFailure() {
                this.failure();
                this.log(`ü•∑üèª Automatically experience a Bandit Activity event instead of a Squatters event`);
                this.boost("Unrest");
              },
            }),
            new LeadershipActivity({
              icon: "üèôÔ∏è",
              name: "Establish Settlement",
              description: "You coordinate the group that founds a new settlement.",
              preprompt: [
                prereq(`The hex in which you‚Äôre establishing the settlement has been Cleared and doesn‚Äôt currently have a settlement (including a Freehold) in it.`),
                p(`You draw up plans, gather resources, entice citizens, and establish boundaries to found a brand new settlement in the hex. A settlement always starts as a village. See page 46 for further details about building settlements.`),
              ],
              criticalSuccessDescription: `Establish settlement`,
              successDescription: `Establish settlement if you reduce 1 Ability by 1`,
              failureDescription: `Establish settlement if you reduce 1 Ability by 2`,
              criticalFailureDescription: `Fail`,
              establish() {
                let namer = Maker.tag("input", {value: `Outpost ${this.domainSheet.data.settlements.length}`});

                this.log(
                  "üéâ You establish the settlement. What'll you name it?",
                  namer,
                  Maker.tag("button", "Do it!", {click: (event) => {
                    let name = namer.value;
                    this.domainSheet.data.settlements.push(new DomainLeader({type: "Village", name: name}));
                    event.target.disabled = true;
                  }})
                );
              },
              conditionalSuccess(cost) {
                this.modOneAnd(
                  `Reduce {ability} by {by} and establish the settlement`,
                  {by: -cost, afterItems: [`Do not establish the settlement right now`], andThen: () => this.establish()});
              },
              criticalSuccess() {
                this.log(`üòÉ You establish the settlement largely with the aid of enthusiastic volunteers.`);
                this.establish();
              },
              success() {
                this.conditionalSuccess(1);
              },
              failure() {
                this.conditionalSuccess(2);
              },
              criticalFailure() { this.log(`‚ùå You fail to establish the settlement`) },
            }),
            new LeadershipActivity({
              icon: "üßéüèª‚Äç‚ôÇÔ∏è",
              name: "Pledge of Fealty",
              description: "You diplomatically invite another group to join the domain.",
              preprompt: [
                p(`When your representatives encounter freeholders, refugees, independent groups, or other bands of individuals gathered in the wilderness who aren‚Äôt already part of a nation, you can offer them a place in your domain, granting them the benefits of protection, security, and prosperity in exchange for their fealty. The benefits granted to your domain can vary wildly, but often manifest as one-time boons to your commodities or unique bonuses against certain types of events. The adventure text in this campaign offers numerous examples of groups who could accept a Pledge of Fealty. Certain groups will respond better (or worse) to specific approaches. The DC is the group‚Äôs Negotiation DC (see the sidebar on page 23).`),
              ],
              abilities: ["Loyalty"],
              dc: "Group DC", // TODO make this work
              criticalSuccessDescription: `Integrate; Claim Hex`,
              successDescription: `Integrate; Reduce 1 Ability by 1`,
              failureDescription: `Fail; Increase Unrest`,
              criticalFailureDescription: `Fail forever; Increase Unrest by 2`,
              criticalSuccess() {
                this.log(`ü§ùüèª The group becomes part of your domain, granting the specific boon or advantage listed in that group‚Äôs entry.`);
                this.log(`üó∫Ô∏è If you haven‚Äôt already claimed the hex in which the group dwells, you immediately do so, gaining Domain XP and increasing Size by 1 (this affects all statistics determined by Size; see page 38). If the hex doesn‚Äôt share a border with your domain, it becomes a secondary territory and checks involving this location take a Control penalty.`);
              },
              success() {
                this.log(`ü§ùüèª The group becomes part of your domain, granting the specific boon or advantage listed in that group‚Äôs entry.`);
                this.log(`üó∫Ô∏è You don‚Äôt claim the hex the group is in.`);
                this.modOneAnd(`Reduce {ability} by 1 to integrate the group into your domain`);
              },
              failure() {
                this.log(`‚ùå The group refuses to pledge to you at this time. You can attempt to get them to Pledge Fealty next turn.`);
                this.boost("Unrest");
              },
              criticalFailure() {
                this.log(`ü§¨ The group refuses to pledge to you‚Äî furthermore, it will never Pledge Fealty to your domain, barring significant in-play changes or actions by the PCs (subject to the GM‚Äôs approval). The group‚Äôs potentially violent rebuff of your offer increases Unrest by 2.`);
                this.boost("Unrest", "Unrest");
              },
            }),
            new LeadershipActivity({
              icon: "üõ£Ô∏è",
              name: "Build Infrastructure",
              description: "You organize the effort to tame the land.",
              preprompt: p(hexMods),
              criticalSuccessDescription: `Build it; Boost 1 Ability you pick`,
              successDescription: `Build it`,
              failureDescription: `Build it if you Reduce 1 Ability by 1`,
              criticalFailureDescription: `Fail`,
              criticalSuccess() {
                this.log(`üöÄ The whole domain rallies around this project.`);
                this.modOneAnd(`Boost {ability}`, {by: 1});
              },
              success() {
                this.log("üõ£Ô∏è The target hex gains a road, bridge, fort, irrigation system, etc");
              },
              failure() {
                this.log("üò∞ Construction is unexpectedly difficult.");
                this.modOneAnd(`Reduce {ability} and build the feature`, {afterItems: [`Do not build`]});
              },
              criticalFailure() {
                this.log("‚ùå The construction process is a failure.");
              },
            }),
            new LeadershipActivity({
              icon: "üí°",
              name: "Creative Solution",
              description: "You plan ahead to make the next action more successful.",
              preprompt: p(`You work with your domain‚Äôs scholars, thinkers, and practitioners of magical and mundane experimentation to come up with new ways to resolve issues when business as usual is just not working. Attempt a basic check.`),
              criticalSuccessDescription: `Bank a Reroll+2 for this turn, and if you don't use it get XP`,
              successDescription: `Bank a Reroll+2 for this turn`,
              failureDescription: `Fail`,
              criticalFailureDescription: `-1 penalty to Culture checks this + next turn`,
              criticalSuccess() {
                this.success();
                this.log(`‚öôÔ∏è If you don‚Äôt use your Creative Solution by the end of this turn, you lose this benefit and gain 10 Domain XP instead.`);
              },
              success() {
                this.log(`üéâ You can call upon the solution to aid in resolving any Domain check made during the remainder of this turn. Do so when a check is rolled, but before you learn the result. Immediately reroll that check with a +2 circumstance bonus; you must take the new result.`);
              },
              failure() { this.log("‚ùå You spend time thinking the problem through, but no solution shows itself.") },
              criticalFailure() {
                this.log(`Your scholars and thinkers are so frustrated that you take a ‚Äì1 circumstance penalty to Culture checks until the end of the NEXT Domain turn.`)
              },
            }),
            new LeadershipActivity({
              icon: "üë®üèª‚Äçüåæ",
              name: "Work the Land",
              description: "You lead a party to harvest the bounty of this realm.",
              preprompt: [
                p(`This boosts the ability above the one you roll:`),
                ol(`Rolling Stability will increase Loyalty`, `Rolling Loyalty will increase Economy`, `Rolling Economy will increase Culture`, `Rolling Culture will increase Stability`),
              ],
              criticalSuccessDescription: `Boost Ability by 2`,
              successDescription: `Boost Ability by 1`,
              failureDescription: `Fail`,
              criticalFailureDescription: `Unrest`,
              criticalSuccess() {
                this.log("üéÅ You make good time and find plentiful resources!");
                this.boost(this.aboveAbility, this.aboveAbility);
              },
              success() {
                this.log("üéâ A fruitful expedition");
                this.boost(this.aboveAbility);
              },
              failure() { this.log("‚ùå Your expedition yields naught") },
              criticalFailure() {
                this.log("üíÄ The expedition is a fiasco; some members do not return alive");
                this.boost("Unrest");
              },
            }),
            new LeadershipActivity({
              icon: "üéÑ",
              name: "Celebrate Holiday",
              description: "You organize a festival where the populace can enjoy themselves.",
              preprompt: [
                p(`You declare a day of celebration. Holidays may be religious, historical, martial, or simply festive, but all relieve your citizens from their labors and give them a chance to make merry at the domain‚Äôs expense.`),
                p(`This boosts the ability below the one you roll:`),
                ol(`Rolling Culture will increase Economy`, `Rolling Economy will increase Loyalty`, `Rolling Loyalty will increase Stability`, `Rolling Stability will increase Culture`),
              ],
              criticalSuccessDescription: `Boost Ability by 2`,
              successDescription: `Boost Ability by 1`,
              failureDescription: `Fail`,
              criticalFailureDescription: `Unrest`,
              criticalSuccess() {
                this.log(`üéÅ Your holiday is a delight to your people. The event is expensive, but incidental income from the celebrants covers the cost.`);
                this.boost(this.belowAbility, this.belowAbility)
              },
              success() {
                this.log(`üéâ Your holiday is a success.`);
                this.boost(this.belowAbility)
              },
              failure() {
                this.log("‚ùå The holiday passes with little enthusiasm, but is still expensive.");
                this.modOneAnd(`Pay for the events with {ability}`);
              },
              criticalFailure() {
                this.log("üÉè Your festival days are poorly organized, and the citizens actively mock your failed attempt to celebrate. A random ability is reduced.")
                this.reduce(this.randomAbility);
              },
            }),
            new LeadershipActivity({
              icon: "ü•∫",
              name: "Request Foreign Aid",
              description: "You entreat aid from a nation you already have diplomatic relations with.",
              preprompt: [
                prereq(`You have diplomatic relations with the group you are requesting aid from`),
                p(`When disaster strikes, you send out a call for help to another nation with whom you have diplomatic relations. The DC of this check is equal to the other group‚Äôs Negotiation DC +2 (see the sidebar on page 23).`),
              ],
              dc: "Group DC", // TODO make this work
              criticalSuccessDescription: `Boost an Ability you pick by 2; +4 bonus to future roll`,
              successDescription: `Boost an Ability you pick by 2`,
              failureDescription: `Boost a random Ability by 1`,
              criticalFailureDescription: `1d4 Unrest`,
              criticalSuccess() {
                this.success();
                this.log(`üéÅ In addition, your ally‚Äôs aid grants a +4 circumstance bonus to any one Domain check attempted during the remainder of this turn. You can choose to apply this bonus to any Domain check after the die is rolled, but must do so before the result is known.`);
              },
              success() {
                this.log(`üéâ Your ally sends the aid you need.`);
                this.modOneAnd(`Boost {ability} by 2`, {by: 2});
              },
              failure() {
                this.log(`ü•° Your ally sends what aid they can.`);
                this.boost(this.randomAbility);
              },
              criticalFailure() {
                this.log(`üí• Your ally is tangled up in its own problems and is unable to assist you, is insulted by your request for aid, or might even have an interest in seeing your domain struggle against one of your ongoing events. Whatever the case, your pleas for aid make your domain look desperate. You gain no aid, but you do increase Unrest by 1d4.`);
                let steps = [1, 2, 3, 4].random();
                this.boost(...new Array(steps).fill("Unrest"));
              },
            }),
            new LeadershipActivity({
              icon: "üé™",
              name: "Bread and Circuses",
              description: "You entertain the populace.",
              criticalSuccessDescription: `Reduce Unrest; Gain Fame`,
              successDescription: `Reduce Unrest`,
              failureDescription: `Reduce Unrest; Reduce an Ability you pick by 1`,
              criticalFailureDescription: `Reduce a random Ability by 1`,
              criticalSuccess() {
                this.success();
                this.log("üó£Ô∏è People come from far and wide to join the festivities, and carry work back to their own lands.")
                this.boost("Fame");
              },
              success() {
                this.log(`üéâ The people enjoy the distraction.`);
                this.reduce("Unrest");
              },
              failure() {
                this.log(`üí∏ The people enjoy the distraction, but it's not cheap.`);
                this.modOneAnd(`Pay with {ability}`, {andThen: () => this.reduce("Unrest")});
              },
              criticalFailure() {
                this.log(`üî• The merriment gets out of hand and riots ensue.`);
                this.reduce(this.randomAbility);
              },
            }),
            new LeadershipActivity({
              icon: "üëÄ",
              name: "Oversee",
              description: "You visit a settlement to ensure vital work gets done.",
              criticalSuccessDescription: `Do a Civic Activity; Increase Stability or Loyalty by 1`,
              successDescription: `Do a Civic Activity`,
              failureDescription: `Do a Civic Activity; Increase Unrest`,
              criticalFailureDescription: `Increase Unrest; Decrease Stability or Loyalty by 1`,
              bumpCivicActivities() {
                this.activityLog.currentTurn.civicActivitiesLeft += 1;
                this.activityLog.currentTurn.civicActivitiesTotal += 1;
              },
              criticalSuccess() {
                this.success();
                this.log(`üëçüèª Your vigilant oversight of this successful project inspires the domain.`);
                this.boost(["Stability", "Loyalty"].random());
              },
              success() {
                this.log(`üéâ You oversee the project to completion.`);
                this.bumpCivicActivities();
              },
              failure() {
                this.log(`üò† The project is completed, but the settlement is annoyed by your methods.`);
                this.bumpCivicActivities();
                this.boost("Unrest");
              },
              criticalFailure() {
                this.log(`ü§¨ The citizenry revolt at your heavy-handedness and refuse to help.`);
                this.boost("Unrest");
                this.boost(["Stability", "Loyalty"].random());
              },
            }),
            new LeadershipActivity({
              icon: "üöã",
              name: "Train Lieutenant",
              description: "You work with an NPC leader to increase their capacity.",
              abilities: ["Loyalty"],
              criticalSuccessDescription: `NPC Leader gets 2 activitys/turn, or success`,
              successDescription: `Leader adds 2 activities to their repertiore`,
              failureDescription: `Fail`,
              criticalFailureDescription: `Leader abandons their post`,
              criticalSuccess() {
                let eligibleLeaders = this.domainSheet.data.leaders.filter(l => l.activitiesPerTurn < 2);
                if (eligibleLeaders.length > 0) {
                  this.log(`üß† An apt pupil! They gain a second activity per turn.`);
                  this.pickOne(eligibleLeaders, {
                    format: (leader) => leader.name,
                    andThen: (picked) => {
                      this.log(`${picked.name} can now do 2 activities per turn`);
                      picked.activitiesPerTurn = 2;
                      this.domainSheet.leadersComponent.render();

                    },
                  });
                } else { this.success() }
              },
              success() {
                this.log(`ü§Ø You teach them more about leadership. Add two actions to those available to them.`);
                this.log(`üéóÔ∏è TODO we should actually track that.`);
              },
              failure() {
                this.log(`üò™ You might not be a great teacher or they might not be a good student, but this didn't work.`);
              },
              criticalFailure() {
                this.log(`ü§¨ You alientate your pupil and they leave their post. They will not return until you apologize.`);
              },
            }),
            new LeadershipActivity({
              icon: "üõ°Ô∏è",
              name: "Hire Adventurers",
              description: "You pay people to tackle an ongoing event.",
              abilities: ["Loyalty"],
              preprompt: (activity) => {return Maker.tag("p",
                p(`While the PCs can strike out themselves to deal with ongoing events, it‚Äôs often more efficient to Hire Adventurers. When you Hire Adventurers to help end an ongoing event, the DC is equal to your Control DC adjusted by the event‚Äôs level modifier.`),
                activity.modOneAnd(`Pay them with {ability}`, {prompt: "Before you roll, pay the mercs:"}),
              )},
              criticalSuccessDescription: `Continuous Event ends`,
              successDescription: `+2 bonus to end event`,
              failureDescription: `Fail`,
              criticalFailureDescription: `Fail; Can't Hire Adventurers for this Event`,
              criticalSuccess() {
                this.log(`‚öîÔ∏è You end the continuous event.`);
              },
              success() {
                this.log(`üî™ The continuous event doesn‚Äôt end, but you gain a +2 circumstance bonus to resolve the event during the next Event phase`);
              },
              failure() {
                this.log(`‚ùå You fail to end the continuous event`);
              },
              criticalFailure() {
                this.failure();
                this.log(`üôä Word spreads quickly through the region‚Äîyou can no longer attempt to end this continuous event by Hiring Adventurers.`);
              },
            }),
            new LeadershipActivity({
              icon: "üîÆ",
              name: "Prognostication",
              description: "You use the mystic arts to forsee future events and prepare for them.",
              preprompt: p(`Your domain‚Äôs spellcasters read the omens and provide advice on how best to prepare for near-future events. Attempt a basic check.`),
              abilities: ["Culture"],
              criticalSuccessDescription: `+2 bonus to resolve event`,
              successDescription: `+1 bonus to resolve event`,
              failureDescription: `Fail`,
              criticalFailureDescription: `-1 penalty to resolve event`,
              criticalSuccess() {
                this.log(`üßø Gain a +2 circumstance bonus to the check to resolve the event.`);
              },
              success() {
                this.log(`üé¥ Gain a +1 circumstance bonus to the check to resolve the event.`);
              },
              failure() {
                this.log(`‚ùå Your spellcasters divine no aid.`);
              },
              criticalFailure() {
                this.log(`üí• Your spellcasters provide inaccurate readings of the future. Take a -1 circumstance penalty to the check to resolve the event`);
              },
            }),
            new LeadershipActivity({
              icon: "üé®",
              name: "Create Masterpiece",
              description: "You use the mystic arts to forsee future events and prepare for them.",
              abilities: ["Culture"],
              preprompt: p(`You encourage your domain‚Äôs artists to create and display a masterful work of art to bolster your domain‚Äôs reputation. Attempt a basic check; the result affects either Fame or Infamy (depending on the type of domain you‚Äôre running). Create a Masterpiece may be attempted only once per domain turn regardless of the number of leaders pursuing activities.`),
              criticalSuccessDescription: `Gain Fame; Boost random Ability by 1`,
              successDescription: `Gain Fame`,
              failureDescription: `Fail`,
              criticalFailureDescription: `Fail; Lose Fame OR 1d4 Unrest`,
              criticalSuccess() {
                this.success();
                this.log(`üí∞ There is a constant stream of people coming to see it for themselves.`);
                this.boost(this.randomAbility);
              },
              success() {
                this.log(`üóø A stunning work of art is created, and people speak of it far and wide.`);
                this.boost("Fame");
              },
              failure() {
                this.log(`‚ùå Your attempt to create a masterpiece fails`);
              },
              criticalFailure() {
                this.log(`üí• Not only does your attempt to create a masterpiece fail, it does so in a dramatic and humiliating way. Lose 1 Fame or Infamy point; if you have no Fame or Infamy points to lose, instead gain 1d4 Unrest.`);
                if (this.domainSheet.data.fame > 0) {
                  this.reduce("Fame");
                } else {
                  let steps = [1, 2, 3, 4].random();
                  this.boost(...new Array(steps).fill("Unrest"));
                }
              },
            }),
          ]
        }
      }
      customElements.define("leadership-activity", LeadershipActivity);

      class CivicActivity extends Activity {
        static get all() {
          let {p, ol} = Maker;

          return [
            new CivicActivity({
              icon: "üí∞",
              name: "Contribute",
              description: "This settlement is hard at work.",
              prompt: "",
              outcome: (ability) => ability.modOneAnd(`Increase {ability}`, {by: 1}),
            }),
            new CivicActivity({
              icon: "üöß",
              name: "Build Structure",
              description: "This settlement has an idea!",
              preprompt: p(`Add building's cost to the DC`),
              abilities: ["Economy"],
              criticalSuccessDescription: `Build it; Boost a random Ability by 1`,
              successDescription: `Build it`,
              failureDescription: `Fail`,
              criticalFailureDescription: `Fail; Reduce a random Ability by 1`,
              criticalSuccess() {
                this.log("üòÇ Everyone rallies to help.");
                this.boost(this.randomAbility);
                this.success();
              },
              success() {
                this.log("üèõÔ∏è You built that thing!");
                this.log("üìà If there are now 2+ buildings in the settlement, it's a town. Get Milestone XP!");
                this.log("üìà If there are now 4+ buildings in the settlement, it's a city. Get Milestone XP!");
                this.log("üìà If there are now 8+ buildings in the settlement, it's a metropolis. Get Milestone XP!");
              },
              failure() { this.log("‚ùå You fail to build the building") },
              criticalFailure() {
                this.log("üíÄ Some workers are killed in a construction accident");
                this.reduce(this.randomAbility);
                this.failure();
              },
            }),
          ];
        }
      }
      customElements.define("civic-activity", CivicActivity);
    </script>
    <script> // Activity Log
      class DomainActivityLog extends RxElement {
        connectedCallback() {
          this.entries = Maker.tag("main", {class: "entries", appendTo: this});
          this.currentTurn = reef.signal({});
          this.resetTurn();
          this.turnSummaries = [];

          this.fillRx(this.currentTurn);
          this.fillStatusBanner();
          this.fillAvailableActivities();
          this.addEventListener("click", this);

          this.initialBoosts();
          this.newTurn(null);
          this.entry({
            title: "Welcome, Domainkeeper",
            description: "You've got a new domain. Let's see how it goes.",
            body: [
              Maker.tag("p", `Here's a little app to do the math so we can see if this system works. Is it too easy? Too hard? Do these activities make sense? Poke around and play to find out!`),
              Maker.tag("p", `
                Click the buttons above to do activities. You can cancel activities until you've picked any buttons inside them, so feel free to explore.`),
              Maker.tag("p", `When you're out of activities each turn, click "New turn" to see a summary of what's changed and start the next turn.`),
              Maker.tag("p", `Warning! Right now it doesn't do anything to try to save your state, so keep that tab open if you care about it! If you want to start again, just reload!`),
            ],
          });

          // For debugging; put `focused: true` in an activity to auto-click it
          let focusedActivity = Activity.all.find(a => a.focused);
          focusedActivity && this.activity(focusedActivity);
        }

        resetTurn() {
          this.currentTurn.leadershipActivitiesTotal = this.domainSheet.leadershipActivitiesPerTurn;
          this.currentTurn.leadershipActivitiesLeft = this.domainSheet.leadershipActivitiesPerTurn;
          this.currentTurn.civicActivitiesTotal = this.domainSheet.civicActivitiesPerTurn;
          this.currentTurn.civicActivitiesLeft = this.domainSheet.civicActivitiesPerTurn;
          this.currentTurn.activities = [];
        }

        fillStatusBanner() {
          reef.component(this.$(".status-banner"), () => {
            let abilities = this.domainSheet.data;
            if (abilities.culture <= 0) {
              return `The domain has lost its identity and fallen into anarchy.`;
            } else if (abilities.economy <= 0) {
              return `The domain is in financial ruin and has fallen into anarchy.`;
            } else if (abilities.loyalty <= 0) {
              return `The citizens have lost faith in each other, and the domain has fallen into anarchy.`;
            } else if (abilities.stability <= 0) {
              return `The domain cannot patrol its lands and has fallen into anarchy.`;
            } else if (abilities.unrest >= 20) {
              return `The people revolt; the domain has fallen into anarchy.`;
            } else {
              return ``;
            }
          });
        }

        fillAvailableActivities() {
          reef.component(this.$(".activities"), () => {
            let leadershipLeft = this.currentTurn.leadershipActivitiesLeft;
            let civicLeft = this.currentTurn.civicActivitiesLeft;
            let activitx = (count) => count == 1 ? "activity" : "activities";

            return `
              <h4>You have ${leadershipLeft} leadership ${activitx(leadershipLeft)} left.</h4>
              <ul class="activities-list leadership-activities">
                ${LeadershipActivity.all.map(activity => activity.button({disabled: leadershipLeft <= 0})).join("")}
              </ul>
              <h4>You have ${civicLeft} civic ${activitx(civicLeft)} left.</h4>
              <ul class="activities-list civic-activities">
                ${CivicActivity.all.map(activity => activity.button({disabled: civicLeft <= 0})).join("")}
              </ul>
              <button class="new-turn ${leadershipLeft + civicLeft > 0 ? "new-turn-pending" : "new-turn-ready"}" data-action="newTurn">New turn</button>`;
          });
        }

        handleEvent(event) {
          let actionTarget = event.target.closest("[data-action]");
          if (actionTarget) { this[actionTarget.dataset.action].call(this, event, {actionTarget}) }
        }

        initialBoosts() {
          let activity = new SystemActivity({
            icon: "üå±",
            name: "Initial Boosts",
            description: "Starting stats",
            prompt: "",
            outcome: "",
          });

          activity.domainSheet.data.abilityBoosts.forEach((boosts) => {
            activity.log(Maker.tag("hr"));
            activity.boost(...boosts);
          });

          this.activity(activity);
        }

        newTurn(event, {name}={}) {
          if (event && (this.currentTurn.leadershipActivitiesLeft > 0 || this.currentTurn.civicActivitiesLeft > 0)) {
            if (!confirm(`You still have actions left; are you sure you want to waste them and end your turn?`)) {
              return;
            }
          }

          let summary = {
            activities: this.currentTurn.activities,
            abilityScores: this.domainSheet.abilityScores,
            statScores: this.domainSheet.statScores,
          };
          this.turnSummaries.push(summary);
          this.domainSummaryEntry(summary);
          
          this.resetTurn();
          this.turnMarker(name || `Turn ${this.turn}`);
        }

        doActivity(event, {actionTarget}) {
          let activityName = actionTarget.dataset.activity;
          let activity = Activity.all.find(a => a.name == activityName);
          this.activity(activity);
        }

        get domainSheet() { return document.querySelector("domain-sheet") }
        get turn() { return this.turnSummaries.length; }

        turnSummary(turn = this.turn) {
          return this.turnSummaries[turn - 1];
        }

        turnMarker(name, title) {
          Maker.tag("article", {class: "turn-marker", prependTo: this.entries, title}, [
            Maker.tag("span", {class: "turn-name"}, name),
          ]);
        }

        withDiffs(newValues, baseline) {
          if (!baseline) { return newValues }

          let retval = {};
          Object.keys(newValues).forEach((ability) => {
            let value = newValues[ability];
            let diff = value - baseline[ability];
            let signClass = diff > 0 ? "diff-positive" : (diff < 0 ? "diff-negative" : "diff-flat");
            retval[ability] = [value, Maker.tag("span", {class: `metadata diff ${signClass}`}, `${diff >= 0 ? "+" : ""}${diff}`)];
          });
          return retval;
        }

        domainSummaryEntry(summary) {
          let lastTurnSummary = this.turnSummary(this.turn - 1);

          this.entry({
            title: "Domain summary",
            description: `Turn ${this.turn}`,
            body: [
              Maker.tag("h4", "Activities taken"),
              Maker.tag("ol", summary.activities.map(activity =>
                Maker.tag("a", activity.icon, {href: "#", title: activity.name, click: () => { setTimeout(() => activity.scrollIntoView(), 1) }})
              )),
              Maker.tag("h4", "Stats at end of turn"),
              Maker.dl(this.withDiffs(summary.abilityScores, lastTurnSummary?.abilityScores), {class: "dl-oneline"}),
              Maker.dl(this.withDiffs(summary.statScores, lastTurnSummary?.statScores), {class: "dl-oneline"}),
            ],
          })
        }

        activity(activity) {
          this.entries.prepend(activity);
          this.currentTurn.activities.push(activity);
          this.countRemainingActivities();
        }

        countRemainingActivities() {
          let left = {};
          left[LeadershipActivity] = this.currentTurn.leadershipActivitiesTotal;
          left[CivicActivity] = this.currentTurn.civicActivitiesTotal;
          this.currentTurn.activities.forEach(activity => {
            left[activity.constructor] -= 1;
          });
          this.currentTurn.leadershipActivitiesLeft = left[LeadershipActivity];
          this.currentTurn.civicActivitiesLeft = left[CivicActivity];
        }

        entry({title, description, body} = {}) {
          Maker.tag("article", {class: "entry", prependTo: this.entries}, [
            Maker.tag("header", title),
            Maker.tag("blockquote", {class: "description"}, description),
            Maker.tag("section", {class: "body"}, body),
          ]);
        }
      }
      customElements.define("domain-activity-log", DomainActivityLog);
    </script>
  </body>
</html>
